import{A as u}from"./chunks/azure-client-CGWqikD7.js";let c=null;chrome.runtime.onInstalled.addListener(async()=>{console.log("๐ Comet-X installed");const e={apiEndpoint:"https://uaenorth.api.cognitive.microsoft.com/",apiKey:"",defaultModel:"gpt-4o",theme:"dark",language:"ar",enableContextMenu:!0,enableKeyboardShortcuts:!0,maxTokens:4096,temperature:.7};(await chrome.storage.sync.get("settings")).settings||await chrome.storage.sync.set({settings:e}),d()});chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0});chrome.action.onClicked.addListener(async e=>{e.id&&await chrome.sidePanel.open({tabId:e.id})});function d(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"comet-x-ask",title:"๐ค ุงุณุฃู Comet-X",contexts:["selection"]}),chrome.contextMenus.create({id:"comet-x-explain",title:"๐ก ุงุดุฑุญ ูุฐุง",contexts:["selection"]}),chrome.contextMenus.create({id:"comet-x-translate",title:"๐ ุชุฑุฌู ุฅูู ุงูุนุฑุจูุฉ",contexts:["selection"]}),chrome.contextMenus.create({id:"comet-x-summarize",title:"๐ ูุฎุต ุงูุตูุญุฉ",contexts:["page"]})})}chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(!(t!=null&&t.id))return;await chrome.sidePanel.open({tabId:t.id}),await new Promise(s=>setTimeout(s,300));const r={"comet-x-ask":"ASK","comet-x-explain":"EXPLAIN","comet-x-translate":"TRANSLATE","comet-x-summarize":"SUMMARIZE"}[e.menuItemId];r&&chrome.runtime.sendMessage({type:r,payload:{text:e.selectionText,pageUrl:e.pageUrl}})});chrome.commands.onCommand.addListener(async(e,t)=>{if(t!=null&&t.id&&e==="ask-ai"){await chrome.sidePanel.open({tabId:t.id});const n=await i(t.id);n&&chrome.runtime.sendMessage({type:"ASK",payload:{text:n}})}});chrome.runtime.onMessage.addListener((e,t,n)=>(m(e,t).then(n).catch(r=>{console.error("Message handler error:",r),n({success:!1,error:r.message})}),!0));async function m(e,t){var n,r;switch(console.log("๐ฉ Received message:",e.type),e.type){case"CHAT":return p(e.payload);case"ANALYZE_PAGE":return g(e.tabId||((n=t.tab)==null?void 0:n.id));case"GET_SELECTION":return y(e.tabId||((r=t.tab)==null?void 0:r.id));case"GET_SETTINGS":return h();case"SAVE_SETTINGS":return f(e.payload);default:return{success:!1,error:`Unknown message type: ${e.type}`}}}async function p(e){const t=await x();if(!t)return{success:!1,error:"AI Client not configured. Please set your API key in settings."};try{const r=[{role:"system",content:S(e.context)},...e.messages.map(o=>({role:o.role,content:o.content}))];return{success:!0,data:await t.chat(r)}}catch(n){return console.error("Chat error:",n),{success:!1,error:n.message}}}async function g(e){if(!e)return{success:!1,error:"No tab ID provided"};try{const[t]=await chrome.scripting.executeScript({target:{tabId:e},func:w});return{success:!0,data:t.result}}catch(t){return{success:!1,error:t.message}}}async function y(e){return e?{success:!0,data:await i(e)}:{success:!1,error:"No tab ID provided"}}async function h(){const{settings:e}=await chrome.storage.sync.get("settings");return{success:!0,data:e}}async function f(e){return await chrome.storage.sync.set({settings:e}),c=null,{success:!0}}async function x(){if(c)return c;const{settings:e}=await chrome.storage.sync.get("settings");return e!=null&&e.apiKey?(c=new u({endpoint:e.apiEndpoint,apiKey:e.apiKey,deploymentName:e.defaultModel,apiVersion:"2024-08-01-preview"}),c):null}async function i(e){try{const[t]=await chrome.scripting.executeScript({target:{tabId:e},func:()=>{var n;return((n=window.getSelection())==null?void 0:n.toString())||null}});return t.result}catch{return null}}function w(){var o,a;const e=document.title,t=window.location.href,n=document.body.innerText.slice(0,1e4),r=(o=document.querySelector('meta[name="description"]'))==null?void 0:o.getAttribute("content"),s=(a=document.querySelector('meta[name="keywords"]'))==null?void 0:a.getAttribute("content");return{url:t,title:e,content:n,metadata:{description:r||void 0,keywords:s==null?void 0:s.split(",").map(l=>l.trim())}}}function S(e){var n;let t=`ุฃูุช Comet-Xุ ูุณุงุนุฏ ุฐูู ูููุชุตูุญ. ุชุณุงุนุฏ ุงููุณุชุฎุฏููู ูู ููู ุงููุญุชูู ูุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ.

ููุงุนุฏ ูููุฉ:
- ุฃุฌุจ ุจููุณ ูุบุฉ ุงูุณุคุงู
- ูู ููุฌุฒุงู ูุฏูููุงู
- ุงุณุชุฎุฏู Markdown ููุชูุณูู ุนูุฏ ุงูุญุงุฌุฉ
- ุฅุฐุง ูู ุชุนุฑู ุงูุฅุฌุงุจุฉุ ูู ุฐูู ุจูุถูุญ`;return e&&(t+=`

--- ุณูุงู ุงูุตูุญุฉ ุงูุญุงููุฉ ---
ุงูุนููุงู: ${e.title}
ุงูุฑุงุจุท: ${e.url}
${e.selectedText?`ุงููุต ุงููุญุฏุฏ: ${e.selectedText}`:""}
${(n=e.metadata)!=null&&n.description?`ุงููุตู: ${e.metadata.description}`:""}

ูุญุชูู ุงูุตูุญุฉ (ูุฎุชุตุฑ):
${e.content.slice(0,3e3)}...`),t}console.log("๐ Comet-X Service Worker loaded");
